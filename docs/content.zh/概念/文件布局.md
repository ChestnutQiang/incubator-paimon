---
title: "文件布局"
weight: 3
type: docs
aliases:
- /概念/文件布局.html
---
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->

# 文件布局

所有表的文件都存储在一个基本目录下。Paimon文件以分层的方式进行组织。下面的图片展示了文件布局。从快照(snapshot)文件开始，Paimon读取器可以递归地访问表中的所有记录。

{{< img src="/img/file-layout.png">}}

## 快照(snapshot)文件

所有快照(snapshot)文件存储在快照(snapshot)目录中。

快照(snapshot)文件是一个包含有关该快照(snapshot)信息的JSON文件，包括：

* 正在使用的schema文件
* 包含该快照(snapshot)所有更改的清单列表(manifest list)

## 清单文件(manifest)

所有清单列表(manifest list)和清单文件(manifest)存储在清单目录中。

清单列表(manifest list)是一组清单文件(manifest)的名称。

清单文件(manifest)是包含有关LSM数据文件和更改日志文件的更改信息的文件。例如，清单文件(manifest)中记录了在相应快照(snapshot)中创建了哪个LSM数据文件以及删除了哪个文件。

## (数据文件)Data Files

数据文件按分区和桶进行分组。每个桶目录包含一个 [LSM tree]({{< ref "概念/文件布局#lsm-trees" >}})及其[changelog files]({{< ref "概念/primary-key-table#changelog-producers" >}})。目前，Paimon支持使用orc（默认）、parquet和avro作为数据文件的格式。

## LSM Trees

Paimon采用LSM tree (log-structured merge-tree) 作为文件存储的数据结构。本文档简要介绍了关于LSM树的概念。

### Sorted Runs

LSM树将文件组织成多个sorted run。一个sorted run由一个或多个[data files]({{< ref "概念/文件布局#data-files" >}})组成，每个数据文件属于且仅属于一个sorted run。

数据文件内部按其主键进行排序。在sorted run内，数据文件的主键范围不会重叠。

{{< img src="/img/sorted-runs.png">}}

正如您所看到的，不同的sorted run可能具有重叠的主键范围，甚至可能包含相同的主键。在查询LSM树时，必须合并所有sorted run，并根据用户指定的[merge engine]({{< ref "概念/primary-key-table#merge-engines" >}})和每个记录的时间戳合并所有具有相同主键的记录。

将新记录写入LSM树时，首先会缓冲在内存中。当内存缓冲区满时，所有内存中的记录将被排序并刷新到磁盘。此时将创建一个新的sorted run。

### 压实(Compaction)

随着越来越多的记录被写入LSM树，sorted run的数量将增加。由于查询LSM树需要合并所有sorted run，过多的sorted run会导致查询性能下降，甚至内存不足。

为了限制sorted run的数量，我们需要定期将几个sorted run合并成一个大的sorted run。这个过程称为压实(compaction)。

然而，压实(compaction)是一个资源密集型的过程，会消耗一定的CPU时间和磁盘IO，因此过于频繁的压实(compaction)可能导致写入速度变慢。这是查询和写入性能之间的权衡。Paimon目前采用了类似于Rocksdb的[universal compaction](https://github.com/facebook/rocksdb/wiki/Universal-Compaction)。

默认情况下，当Paimon将记录追加到LSM树时，它也会根据需要执行压实(compaction)。用户还可以选择在专用的压实(compaction)作业中执行所有压实(compaction)。有关更多信息，请参阅[dedicated compaction job]({{< ref "maintenance/multiple-writers#dedicated-compaction-job" >}})。
